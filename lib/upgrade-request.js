"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.__test__ = undefined;

exports.default = function (options) {
    let LOG = options.logger;
    let yarnpkg = new _yarnpkg2.default(options.workingdir, LOG);
    let git = new _git2.default(options.workingdir, LOG);
    return yarnpkg.install().then(() => yarnpkg.outdated()).then(out => findOutdatedDeps(LOG, out)).then(([diff, hex]) => git.fetch("origin").then(() => [diff, hex])).then(([diff, hex]) => git.branchList().then(names => [names, diff, hex])).then(([names, diff, hex]) => findExistingBranch(LOG, options, names, diff, hex)).then(([newBranch, diff]) => git.checkoutWith(newBranch).then(() => diff)).then(diff => collectModuleVersions(options).then(mv => [mv, diff])).then(([mv, diff]) => yarnpkg.upgrade().then(out => computeUpdatedDependencies(LOG, options, diff, mv, out))).then(diff => git.setup(options.username, options.useremail).then(() => diff)).then(diff => git.add("yarn.lock").then(() => diff)).then(diff => git.commit("update dependencies").then(() => diff)).then(diff => git.currentBranch().then(newBranch => [newBranch, diff])).then(([newBranch, diff]) => git.checkout("-").then(() => [newBranch, diff])).then(([newBranch, diff]) => git.currentBranch().then(baseBranch => [baseBranch, newBranch, diff])).then(([baseBranch, newBranch, diff]) => selectPushPromise(LOG, options, git, "origin", newBranch).then(() => [baseBranch, newBranch, diff])).then(([baseBranch, newBranch, diff]) => git.remoteurl("origin").then(remote => [new _github2.default(options, remote), baseBranch, newBranch, diff])).then(([github, baseBranch, newBranch, diff]) => github.pullRequest(baseBranch, newBranch, diff).then(report => [report, newBranch])).then(([report, newBranch]) => selectDeletePromise(LOG, options, git, newBranch, report));
};

var _sha = require("sha.js");

var _sha2 = _interopRequireDefault(_sha);

var _fs = require("mz/fs");

var _fs2 = _interopRequireDefault(_fs);

var _path = require("path");

var _path2 = _interopRequireDefault(_path);

var _yarnpkg = require("./yarnpkg");

var _yarnpkg2 = _interopRequireDefault(_yarnpkg);

var _git = require("./git");

var _git2 = _interopRequireDefault(_git);

var _github = require("./github");

var _github2 = _interopRequireDefault(_github);

var _readPackageJson = require("./promise/read-package-json");

var _readPackageJson2 = _interopRequireDefault(_readPackageJson);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function findOutdatedDeps(LOG, out) {
    LOG("Find some outdated dependencies.");
    LOG(`difference table ${out}`);
    if (out) {
        let diff = JSON.parse(out).data.body;
        if (diff && diff.some(v => v[1] !== v[2])) {
            LOG("Found outdated dependencies.");
            let hex = new _sha2.default.sha1().update(out, "utf8").digest("hex");
            return [diff, hex];
        }
    }
    LOG("Did not find outdated dependencies.");
    return Promise.reject("dependencies are not up to date.");
}

function collectModuleVersions(options) {
    if (options.withShadows) {
        let modules = _path2.default.join(options.workingdir, "node_modules");
        return _fs2.default.readdir(modules).then(files => {
            let ps = files.map(n => _path2.default.join(modules, n)).map(n => [n, _fs2.default.statSync(n)]).filter(v => v[1].isDirectory()).map(v => _path2.default.join(v[0], "package.json")).map(n => [n, _fs2.default.existsSync(n)]).filter(v => v[1]).map(v => (0, _readPackageJson2.default)(v[0]));
            return Promise.all(ps).then(pkgs => {
                return new Map(pkgs.map(pkg => [pkg.name, pkg.version]));
            });
        });
    }
    return Promise.resolve(new Map());
}

function computeUpdatedDependencies(LOG, options, diff, mv, out) {
    LOG("compute shadow dependencies");
    if (options.withShadows) {
        let msgs = out.split(/[\r]?\n/);
        let tree = JSON.parse(msgs[msgs.length - 1]);

        let names = new Set(diff.map(d => d[0]));
        let shadows = tree.data.trees.map(v => v.name.split(/@/)).filter(([name, version]) => {
            let cur = mv.get(name);
            return cur ? cur !== version : true;
        }).map(([name, version]) => {
            let cur = mv.get(name);
            return [name, cur || version, version, undefined, "shadow"];
        }).filter(v => names.has(v[0]) === false);
        return diff.concat(shadows.sort((left, right) => {
            return left[0].localeCompare(right[0]);
        }));
    }
    return diff;
}

function findExistingBranch(LOG, options, names, diff, hex) {
    LOG("Find existing branch.");
    let newBranch = `${options.prefix}${options.now}/${hex}`;
    let found = names.find(n => n.endsWith(hex));
    if (found) {
        LOG(`Found existing branch ${found}`);
        return Promise.reject("Working Branch is already exists.");
    }
    return [newBranch, diff];
}

function selectPushPromise(LOG, options, git, remote, branch) {
    if (options.execute) {
        return git.push(remote, branch);
    }
    LOG("`git push` is skipped because --execute is not specified.");
    return Promise.resolve();
}

function selectDeletePromise(LOG, options, git, branch, report) {
    let p;
    if (options.keep) {
        LOG("Working branch is kept.");
        p = Promise.resolve();
    } else {
        LOG("Delete working branch because --keep is not specified.");
        p = git.deleteBranch(branch);
    }
    return p.then(() => report);
}

// for tesing purpose
const __test__ = exports.__test__ = [findOutdatedDeps, findExistingBranch, selectPushPromise, selectDeletePromise];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91cGdyYWRlLXJlcXVlc3QuanMiXSwibmFtZXMiOlsib3B0aW9ucyIsIkxPRyIsImxvZ2dlciIsInlhcm5wa2ciLCJ3b3JraW5nZGlyIiwiZ2l0IiwiaW5zdGFsbCIsInRoZW4iLCJvdXRkYXRlZCIsIm91dCIsImZpbmRPdXRkYXRlZERlcHMiLCJkaWZmIiwiaGV4IiwiZmV0Y2giLCJicmFuY2hMaXN0IiwibmFtZXMiLCJmaW5kRXhpc3RpbmdCcmFuY2giLCJuZXdCcmFuY2giLCJjaGVja291dFdpdGgiLCJjb2xsZWN0TW9kdWxlVmVyc2lvbnMiLCJtdiIsInVwZ3JhZGUiLCJjb21wdXRlVXBkYXRlZERlcGVuZGVuY2llcyIsInNldHVwIiwidXNlcm5hbWUiLCJ1c2VyZW1haWwiLCJhZGQiLCJjb21taXQiLCJjdXJyZW50QnJhbmNoIiwiY2hlY2tvdXQiLCJiYXNlQnJhbmNoIiwic2VsZWN0UHVzaFByb21pc2UiLCJyZW1vdGV1cmwiLCJyZW1vdGUiLCJnaXRodWIiLCJwdWxsUmVxdWVzdCIsInJlcG9ydCIsInNlbGVjdERlbGV0ZVByb21pc2UiLCJKU09OIiwicGFyc2UiLCJkYXRhIiwiYm9keSIsInNvbWUiLCJ2Iiwic2hhMSIsInVwZGF0ZSIsImRpZ2VzdCIsIlByb21pc2UiLCJyZWplY3QiLCJ3aXRoU2hhZG93cyIsIm1vZHVsZXMiLCJqb2luIiwicmVhZGRpciIsImZpbGVzIiwicHMiLCJtYXAiLCJuIiwic3RhdFN5bmMiLCJmaWx0ZXIiLCJpc0RpcmVjdG9yeSIsImV4aXN0c1N5bmMiLCJhbGwiLCJwa2dzIiwiTWFwIiwicGtnIiwibmFtZSIsInZlcnNpb24iLCJyZXNvbHZlIiwibXNncyIsInNwbGl0IiwidHJlZSIsImxlbmd0aCIsIlNldCIsImQiLCJzaGFkb3dzIiwidHJlZXMiLCJjdXIiLCJnZXQiLCJ1bmRlZmluZWQiLCJoYXMiLCJjb25jYXQiLCJzb3J0IiwibGVmdCIsInJpZ2h0IiwibG9jYWxlQ29tcGFyZSIsInByZWZpeCIsIm5vdyIsImZvdW5kIiwiZmluZCIsImVuZHNXaXRoIiwiYnJhbmNoIiwiZXhlY3V0ZSIsInB1c2giLCJwIiwia2VlcCIsImRlbGV0ZUJyYW5jaCIsIl9fdGVzdF9fIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O2tCQXVHZSxVQUFVQSxPQUFWLEVBQW1CO0FBQzlCLFFBQUlDLE1BQU1ELFFBQVFFLE1BQWxCO0FBQ0EsUUFBSUMsVUFBVSxzQkFBWUgsUUFBUUksVUFBcEIsRUFBZ0NILEdBQWhDLENBQWQ7QUFDQSxRQUFJSSxNQUFNLGtCQUFRTCxRQUFRSSxVQUFoQixFQUE0QkgsR0FBNUIsQ0FBVjtBQUNBLFdBQU9FLFFBQVFHLE9BQVIsR0FDRkMsSUFERSxDQUNHLE1BQU1KLFFBQVFLLFFBQVIsRUFEVCxFQUVGRCxJQUZFLENBRUdFLE9BQU9DLGlCQUFpQlQsR0FBakIsRUFBc0JRLEdBQXRCLENBRlYsRUFHRkYsSUFIRSxDQUdHLENBQUMsQ0FBQ0ksSUFBRCxFQUFPQyxHQUFQLENBQUQsS0FBaUJQLElBQUlRLEtBQUosQ0FBVSxRQUFWLEVBQW9CTixJQUFwQixDQUF5QixNQUFNLENBQUNJLElBQUQsRUFBT0MsR0FBUCxDQUEvQixDQUhwQixFQUlGTCxJQUpFLENBSUcsQ0FBQyxDQUFDSSxJQUFELEVBQU9DLEdBQVAsQ0FBRCxLQUFpQlAsSUFBSVMsVUFBSixHQUFpQlAsSUFBakIsQ0FBc0JRLFNBQVMsQ0FBQ0EsS0FBRCxFQUFRSixJQUFSLEVBQWNDLEdBQWQsQ0FBL0IsQ0FKcEIsRUFLRkwsSUFMRSxDQUtHLENBQUMsQ0FBQ1EsS0FBRCxFQUFRSixJQUFSLEVBQWNDLEdBQWQsQ0FBRCxLQUF3QkksbUJBQW1CZixHQUFuQixFQUF3QkQsT0FBeEIsRUFBaUNlLEtBQWpDLEVBQXdDSixJQUF4QyxFQUE4Q0MsR0FBOUMsQ0FMM0IsRUFNRkwsSUFORSxDQU1HLENBQUMsQ0FBQ1UsU0FBRCxFQUFZTixJQUFaLENBQUQsS0FBdUJOLElBQUlhLFlBQUosQ0FBaUJELFNBQWpCLEVBQTRCVixJQUE1QixDQUFpQyxNQUFN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O0FBQ0EsZUFBT3hDLFFBQVFDLE1BQVIsQ0FBZSxtQ0FBZixDQUFQO0FBQ0g7QUFDRCxXQUFPLENBQUMvQixTQUFELEVBQVlOLElBQVosQ0FBUDtBQUNIOztBQUVELFNBQVNvQixpQkFBVCxDQUEyQjlCLEdBQTNCLEVBQWdDRCxPQUFoQyxFQUF5Q0ssR0FBekMsRUFBOEM0QixNQUE5QyxFQUFzRHlELE1BQXRELEVBQThEO0FBQzFELFFBQUkxRixRQUFRMkYsT0FBWixFQUFxQjtBQUNqQixlQUFPdEYsSUFBSXVGLElBQUosQ0FBUzNELE1BQVQsRUFBaUJ5RCxNQUFqQixDQUFQO0FBQ0g7QUFDRHpGLFFBQUksMkRBQUo7QUFDQSxXQUFPOEMsUUFBUW9CLE9BQVIsRUFBUDtBQUNIOztBQUVELFNBQVM5QixtQkFBVCxDQUE2QnBDLEdBQTdCLEVBQWtDRCxPQUFsQyxFQUEyQ0ssR0FBM0MsRUFBZ0RxRixNQUFoRCxFQUF3RHRELE1BQXhELEVBQWdFO0FBQzVELFFBQUl5RCxDQUFKO0FBQ0EsUUFBSTdGLFFBQVE4RixJQUFaLEVBQWtCO0FBQ2Q3RixZQUFJLHlCQUFKO0FBQ0E0RixZQUFJOUMsUUFBUW9CLE9BQVIsRUFBSjtBQUNILEtBSEQsTUFHTztBQUNIbEUsWUFBSSx3REFBSjtBQUNBNEYsWUFBSXhGLElBQUkwRixZQUFKLENBQWlCTCxNQUFqQixDQUFKO0FBQ0g7QUFDRCxXQUFPRyxFQUFFdEYsSUFBRixDQUFPLE1BQU02QixNQUFiLENBQVA7QUFDSDs7QUFFRDtBQUNPLE1BQU00RCw4QkFBVyxDQUFDdEYsZ0JBQUQsRUFBbUJNLGtCQUFuQixFQUF1Q2UsaUJBQXZDLEVBQTBETSxtQkFBMUQsQ0FBakIiLCJmaWxlIjoidXBncmFkZS1yZXF1ZXN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGhhc2ggZnJvbSBcInNoYS5qc1wiO1xuaW1wb3J0IGZzIGZyb20gXCJtei9mc1wiO1xuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcblxuaW1wb3J0IFlhcm5wa2cgZnJvbSBcIi4veWFybnBrZ1wiO1xuaW1wb3J0IEdpdCBmcm9tIFwiLi9naXRcIjtcbmltcG9ydCBHaXRIdWIgZnJvbSBcIi4vZ2l0aHViXCI7XG5pbXBvcnQgcnBqIGZyb20gXCIuL3Byb21pc2UvcmVhZC1wYWNrYWdlLWpzb25cIjtcblxuZnVuY3Rpb24gZmluZE91dGRhdGVkRGVwcyhMT0csIG91dCkge1xuICAgIExPRyhcIkZpbmQgc29tZSBvdXRkYXRlZCBkZXBlbmRlbmNpZXMuXCIpO1xuICAgIExPRyhgZGlmZmVyZW5jZSB0YWJsZSAke291dH1gKTtcbiAgICBpZiAob3V0KSB7XG4gICAgICAgIGxldCBkaWZmID0gSlNPTi5wYXJzZShvdXQpLmRhdGEuYm9keTtcbiAgICAgICAgaWYgKGRpZmYgJiYgZGlmZi5zb21lKHYgPT4gdlsxXSAhPT0gdlsyXSkpIHtcbiAgICAgICAgICAgIExPRyhcIkZvdW5kIG91dGRhdGVkIGRlcGVuZGVuY2llcy5cIik7XG4gICAgICAgICAgICBsZXQgaGV4ID0gbmV3IGhhc2guc2hhMSgpLnVwZGF0ZShvdXQsIFwidXRmOFwiKS5kaWdlc3QoXCJoZXhcIik7XG4gICAgICAgICAgICByZXR1cm4gW2RpZmYsIGhleF07XG4gICAgICAgIH1cbiAgICB9XG4gICAgTE9HKFwiRGlkIG5vdCBmaW5kIG91dGRhdGVkIGRlcGVuZGVuY2llcy5cIik7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KFwiZGVwZW5kZW5jaWVzIGFyZSBub3QgdXAgdG8gZGF0ZS5cIik7XG59XG5cbmZ1bmN0aW9uIGNvbGxlY3RNb2R1bGVWZXJzaW9ucyhvcHRpb25zKSB7XG4gICAgaWYgKG9wdGlvbnMud2l0aFNoYWRvd3MpIHtcbiAgICAgICAgbGV0IG1vZHVsZXMgPSBwYXRoLmpvaW4ob3B0aW9ucy53b3JraW5nZGlyLCBcIm5vZGVfbW9kdWxlc1wiKTtcbiAgICAgICAgcmV0dXJuIGZzLnJlYWRkaXIobW9kdWxlcykudGhlbihmaWxlcyA9PiB7XG4gICAgICAgICAgICBsZXQgcHMgPSBmaWxlc1xuICAgICAgICAgICAgICAgIC5tYXAobiA9PiBwYXRoLmpvaW4obW9kdWxlcywgbikpXG4gICAgICAgICAgICAgICAgLm1hcChuID0+IFtuLCBmcy5zdGF0U3luYyhuKV0pXG4gICAgICAgICAgICAgICAgLmZpbHRlcih2ID0+IHZbMV0uaXNEaXJlY3RvcnkoKSlcbiAgICAgICAgICAgICAgICAubWFwKHYgPT4gcGF0aC5qb2luKHZbMF0sIFwicGFja2FnZS5qc29uXCIpKVxuICAgICAgICAgICAgICAgIC5tYXAobiA9PiBbbiwgZnMuZXhpc3RzU3luYyhuKV0pXG4gICAgICAgICAgICAgICAgLmZpbHRlcih2ID0+IHZbMV0pXG4gICAgICAgICAgICAgICAgLm1hcCh2ID0+IHJwaih2WzBdKSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHMpLnRoZW4ocGtncyA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBNYXAocGtncy5tYXAocGtnID0+IFtwa2cubmFtZSwgcGtnLnZlcnNpb25dKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobmV3IE1hcCgpKTtcbn1cblxuZnVuY3Rpb24gY29tcHV0ZVVwZGF0ZWREZXBlbmRlbmNpZXMoTE9HLCBvcHRpb25zLCBkaWZmLCBtdiwgb3V0KSB7XG4gICAgTE9HKFwiY29tcHV0ZSBzaGFkb3cgZGVwZW5kZW5jaWVzXCIpO1xuICAgIGlmIChvcHRpb25zLndpdGhTaGFkb3dzKSB7XG4gICAgICAgIGxldCBtc2dzID0gb3V0LnNwbGl0KC9bXFxyXT9cXG4vKTtcbiAgICAgICAgbGV0IHRyZWUgPSBKU09OLnBhcnNlKG1zZ3NbbXNncy5sZW5ndGggLSAxXSk7XG5cbiAgICAgICAgbGV0IG5hbWVzID0gbmV3IFNldChkaWZmLm1hcChkID0+IGRbMF0pKTtcbiAgICAgICAgbGV0IHNoYWRvd3MgPSB0cmVlLmRhdGEudHJlZXNcbiAgICAgICAgICAgIC5tYXAodiA9PiB2Lm5hbWUuc3BsaXQoL0AvKSlcbiAgICAgICAgICAgIC5maWx0ZXIoKFtuYW1lLCB2ZXJzaW9uXSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjdXIgPSBtdi5nZXQobmFtZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1ciA/IGN1ciAhPT0gdmVyc2lvbiA6IHRydWU7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm1hcCgoW25hbWUsIHZlcnNpb25dKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGN1ciA9IG12LmdldChuYW1lKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gW25hbWUsIGN1ciB8fCB2ZXJzaW9uLCB2ZXJzaW9uLCB1bmRlZmluZWQsIFwic2hhZG93XCJdO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5maWx0ZXIodiA9PiBuYW1lcy5oYXModlswXSkgPT09IGZhbHNlKTtcbiAgICAgICAgcmV0dXJuIGRpZmYuY29uY2F0KHNoYWRvd3Muc29ydCgobGVmdCwgcmlnaHQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBsZWZ0WzBdLmxvY2FsZUNvbXBhcmUocmlnaHRbMF0pO1xuICAgICAgICB9KSk7XG4gICAgfVxuICAgIHJldHVybiBkaWZmO1xufVxuXG5mdW5jdGlvbiBmaW5kRXhpc3RpbmdCcmFuY2goTE9HLCBvcHRpb25zLCBuYW1lcywgZGlmZiwgaGV4KSB7XG4gICAgTE9HKFwiRmluZCBleGlzdGluZyBicmFuY2guXCIpO1xuICAgIGxldCBuZXdCcmFuY2ggPSBgJHtvcHRpb25zLnByZWZpeH0ke29wdGlvbnMubm93fS8ke2hleH1gO1xuICAgIGxldCBmb3VuZCA9IG5hbWVzLmZpbmQobiA9PiBuLmVuZHNXaXRoKGhleCkpO1xuICAgIGlmIChmb3VuZCkge1xuICAgICAgICBMT0coYEZvdW5kIGV4aXN0aW5nIGJyYW5jaCAke2ZvdW5kfWApO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoXCJXb3JraW5nIEJyYW5jaCBpcyBhbHJlYWR5IGV4aXN0cy5cIik7XG4gICAgfVxuICAgIHJldHVybiBbbmV3QnJhbmNoLCBkaWZmXTtcbn1cblxuZnVuY3Rpb24gc2VsZWN0UHVzaFByb21pc2UoTE9HLCBvcHRpb25zLCBnaXQsIHJlbW90ZSwgYnJhbmNoKSB7XG4gICAgaWYgKG9wdGlvbnMuZXhlY3V0ZSkge1xuICAgICAgICByZXR1cm4gZ2l0LnB1c2gocmVtb3RlLCBicmFuY2gpO1xuICAgIH1cbiAgICBMT0coXCJgZ2l0IHB1c2hgIGlzIHNraXBwZWQgYmVjYXVzZSAtLWV4ZWN1dGUgaXMgbm90IHNwZWNpZmllZC5cIik7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xufVxuXG5mdW5jdGlvbiBzZWxlY3REZWxldGVQcm9taXNlKExPRywgb3B0aW9ucywgZ2l0LCBicmFuY2gsIHJlcG9ydCkge1xuICAgIGxldCBwO1xuICAgIGlmIChvcHRpb25zLmtlZXApIHtcbiAgICAgICAgTE9HKFwiV29ya2luZyBicmFuY2ggaXMga2VwdC5cIik7XG4gICAgICAgIHAgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBMT0coXCJEZWxldGUgd29ya2luZyBicmFuY2ggYmVjYXVzZSAtLWtlZXAgaXMgbm90IHNwZWNpZmllZC5cIik7XG4gICAgICAgIHAgPSBnaXQuZGVsZXRlQnJhbmNoKGJyYW5jaCk7XG4gICAgfVxuICAgIHJldHVybiBwLnRoZW4oKCkgPT4gcmVwb3J0KTtcbn1cblxuLy8gZm9yIHRlc2luZyBwdXJwb3NlXG5leHBvcnQgY29uc3QgX190ZXN0X18gPSBbZmluZE91dGRhdGVkRGVwcywgZmluZEV4aXN0aW5nQnJhbmNoLCBzZWxlY3RQdXNoUHJvbWlzZSwgc2VsZWN0RGVsZXRlUHJvbWlzZV07XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgbGV0IExPRyA9IG9wdGlvbnMubG9nZ2VyO1xuICAgIGxldCB5YXJucGtnID0gbmV3IFlhcm5wa2cob3B0aW9ucy53b3JraW5nZGlyLCBMT0cpO1xuICAgIGxldCBnaXQgPSBuZXcgR2l0KG9wdGlvbnMud29ya2luZ2RpciwgTE9HKTtcbiAgICByZXR1cm4geWFybnBrZy5pbnN0YWxsKClcbiAgICAgICAgLnRoZW4oKCkgPT4geWFybnBrZy5vdXRkYXRlZCgpKVxuICAgICAgICAudGhlbihvdXQgPT4gZmluZE91dGRhdGVkRGVwcyhMT0csIG91dCkpXG4gICAgICAgIC50aGVuKChbZGlmZiwgaGV4XSkgPT4gZ2l0LmZldGNoKFwib3JpZ2luXCIpLnRoZW4oKCkgPT4gW2RpZmYsIGhleF0pKVxuICAgICAgICAudGhlbigoW2RpZmYsIGhleF0pID0+IGdpdC5icmFuY2hMaXN0KCkudGhlbihuYW1lcyA9PiBbbmFtZXMsIGRpZmYsIGhleF0pKVxuICAgICAgICAudGhlbigoW25hbWVzLCBkaWZmLCBoZXhdKSA9PiBmaW5kRXhpc3RpbmdCcmFuY2goTE9HLCBvcHRpb25zLCBuYW1lcywgZGlmZiwgaGV4KSlcbiAgICAgICAgLnRoZW4oKFtuZXdCcmFuY2gsIGRpZmZdKSA9PiBnaXQuY2hlY2tvdXRXaXRoKG5ld0JyYW5jaCkudGhlbigoKSA9PiBkaWZmKSlcbiAgICAgICAgLnRoZW4oZGlmZiA9PiBjb2xsZWN0TW9kdWxlVmVyc2lvbnMob3B0aW9ucykudGhlbihtdiA9PiBbbXYsIGRpZmZdKSlcbiAgICAgICAgLnRoZW4oKFttdiwgZGlmZl0pID0+IHlhcm5wa2cudXBncmFkZSgpLnRoZW4ob3V0ID0+IGNvbXB1dGVVcGRhdGVkRGVwZW5kZW5jaWVzKExPRywgb3B0aW9ucywgZGlmZiwgbXYsIG91dCkpKVxuICAgICAgICAudGhlbihkaWZmID0+IGdpdC5zZXR1cChvcHRpb25zLnVzZXJuYW1lLCBvcHRpb25zLnVzZXJlbWFpbCkudGhlbigoKSA9PiBkaWZmKSlcbiAgICAgICAgLnRoZW4oZGlmZiA9PiBnaXQuYWRkKFwieWFybi5sb2NrXCIpLnRoZW4oKCkgPT4gZGlmZikpXG4gICAgICAgIC50aGVuKGRpZmYgPT4gZ2l0LmNvbW1pdChcInVwZGF0ZSBkZXBlbmRlbmNpZXNcIikudGhlbigoKSA9PiBkaWZmKSlcbiAgICAgICAgLnRoZW4oZGlmZiA9PiBnaXQuY3VycmVudEJyYW5jaCgpLnRoZW4obmV3QnJhbmNoID0+IFtuZXdCcmFuY2gsIGRpZmZdKSlcbiAgICAgICAgLnRoZW4oKFtuZXdCcmFuY2gsIGRpZmZdKSA9PiBnaXQuY2hlY2tvdXQoXCItXCIpLnRoZW4oKCkgPT4gKFtuZXdCcmFuY2gsIGRpZmZdKSkpXG4gICAgICAgIC50aGVuKChbbmV3QnJhbmNoLCBkaWZmXSkgPT4gZ2l0LmN1cnJlbnRCcmFuY2goKS50aGVuKGJhc2VCcmFuY2ggPT4gW2Jhc2VCcmFuY2gsIG5ld0JyYW5jaCwgZGlmZl0pKVxuICAgICAgICAudGhlbigoW2Jhc2VCcmFuY2gsIG5ld0JyYW5jaCwgZGlmZl0pID0+XG4gICAgICAgICAgICBzZWxlY3RQdXNoUHJvbWlzZShMT0csIG9wdGlvbnMsIGdpdCwgXCJvcmlnaW5cIiwgbmV3QnJhbmNoKVxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IFtiYXNlQnJhbmNoLCBuZXdCcmFuY2gsIGRpZmZdKSlcbiAgICAgICAgLnRoZW4oKFtiYXNlQnJhbmNoLCBuZXdCcmFuY2gsIGRpZmZdKSA9PiBnaXQucmVtb3RldXJsKFwib3JpZ2luXCIpXG4gICAgICAgICAgICAudGhlbihyZW1vdGUgPT4gW25ldyBHaXRIdWIob3B0aW9ucywgcmVtb3RlKSwgYmFzZUJyYW5jaCwgbmV3QnJhbmNoLCBkaWZmXSkpXG4gICAgICAgIC50aGVuKChbZ2l0aHViLCBiYXNlQnJhbmNoLCBuZXdCcmFuY2gsIGRpZmZdKSA9PlxuICAgICAgICAgICAgZ2l0aHViLnB1bGxSZXF1ZXN0KGJhc2VCcmFuY2gsIG5ld0JyYW5jaCwgZGlmZilcbiAgICAgICAgICAgICAgICAudGhlbihyZXBvcnQgPT4gW3JlcG9ydCwgbmV3QnJhbmNoXSkpXG4gICAgICAgIC50aGVuKChbcmVwb3J0LCBuZXdCcmFuY2hdKSA9PlxuICAgICAgICAgICAgc2VsZWN0RGVsZXRlUHJvbWlzZShMT0csIG9wdGlvbnMsIGdpdCwgbmV3QnJhbmNoLCByZXBvcnQpKTtcbn1cbiJdfQ==